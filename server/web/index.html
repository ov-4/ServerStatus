<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServerStatus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 20px; background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 0 15px rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 20px; background: #fff; }
        .card-header { background: #fff; border-bottom: 1px solid #eee; font-weight: 600; color: #555; padding: 15px 20px; }
        
        /* åˆ—è¡¨æ ·å¼ */
        .table { margin-bottom: 0; }
        .table thead th { border-top: 0; border-bottom-width: 1px; font-weight: 600; color: #666; background: #f8f9fa; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; cursor: pointer; transition: background 0.2s; }
        
        /* çŠ¶æ€ç‚¹ */
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-online { background-color: #28a745; box-shadow: 0 0 5px rgba(40,167,69,0.5); }
        .status-offline { background-color: #dc3545; }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-box { position: relative; height: 280px; width: 100%; }
        
        /* è¿›åº¦æ¡ */
        .progress { height: 6px; margin-top: 5px; background-color: #e9ecef; }
        
        .d-none { display: none !important; }
        .btn-back { margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ServerStatus <small class="text-muted fs-6">Live</small></h3>
        <span class="badge bg-success" id="status-badge">Connected</span>
    </div>

    <div id="dashboard">
        <div class="card">
            <div class="card-body p-0">
                <table class="table table-hover align-middle text-center">
                    <thead>
                        <tr>
                            <th class="text-start ps-4">Server</th>
                            <th style="width:25%">CPU</th>
                            <th>RAM</th>
                            <th>Network (In/Out)</th>
                            <th>Disk</th>
                        </tr>
                    </thead>
                    <tbody id="server-list">
                        <tr><td colspan="5" class="text-muted py-4">Waiting for data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="detail" class="d-none">
        <button class="btn btn-outline-secondary btn-sm btn-back" onclick="showDashboard()">
            &larr; Back to List
        </button>
        <h4 id="detail-title" class="mb-4"></h4>
        
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">CPU & Memory</div>
                    <div class="card-body">
                        <div class="chart-box"><canvas id="chartCpuRam"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">Network</div>
                    <div class="card-body">
                        <div class="chart-box"><canvas id="chartNet"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentDetailId = null;
    
    // å›¾è¡¨å®ä¾‹å®¹å™¨
    const chartInstances = {
        cpuRam: null,
        net: null
    };

    // Chart.js é€šç”¨é…ç½® (æ¨¡ä»¿ Nezha/Grafana é£æ ¼)
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.color = '#666';
    
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // ğŸš« ç¦ç”¨å…¨å±€é»˜è®¤åŠ¨ç”»ï¼Œè¿™æ˜¯è§£å†³â€œçº¿æ¡ä¹±é•¿â€çš„å…³é”®
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            tooltip: {
                enabled: true,
                mode: 'index',
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                titleColor: '#333',
                bodyColor: '#333',
                borderColor: '#ddd',
                borderWidth: 1,
                padding: 10,
                displayColors: true
            },
            legend: {
                labels: { usePointStyle: true, boxWidth: 6 }
            }
        },
        scales: {
            x: {
                grid: { display: false, drawBorder: false },
                ticks: { display: false } // éšè—Xè½´æ—¶é—´æ ‡ç­¾ï¼Œä¿æŒç®€æ´
            },
            y: {
                grid: { color: '#f0f0f0', borderDash: [3, 3] },
                beginAtZero: true
            }
        },
        elements: {
            point: { radius: 0, hoverRadius: 5 }, // å¹³æ—¶éšè—ç‚¹ï¼Œé¼ æ ‡æ”¾ä¸Šå»æ‰æ˜¾ç¤º
            line: { tension: 0.4, borderWidth: 2 } // æ›²çº¿å¹³æ»‘
        }
    };

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB', 'TB'][i];
    }

    // ================= æ ¸å¿ƒé€»è¾‘ =================

    async function tick() {
        try {
            // 1. è·å–åˆ—è¡¨æ•°æ®
            const listRes = await fetch('/api/stats');
            const listData = await listRes.json();
            
            document.getElementById('status-badge').className = 'badge bg-success';
            document.getElementById('status-badge').innerText = 'Live';

            if (!currentDetailId) {
                renderList(listData);
            } else {
                // 2. å¦‚æœåœ¨è¯¦æƒ…é¡µï¼Œé¢å¤–è·å–å†å²æ•°æ®
                const historyRes = await fetch(`/api/history?id=${currentDetailId}`);
                const historyData = await historyRes.json();
                updateCharts(historyData);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('status-badge').className = 'badge bg-danger';
            document.getElementById('status-badge').innerText = 'Offline';
        }
    }

    function renderList(data) {
        const tbody = document.getElementById('server-list');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Waiting for data...</td></tr>';
            return;
        }

        let html = '';
        data.forEach(s => {
            let cpuClass = s.cpu > 80 ? 'bg-danger' : (s.cpu > 50 ? 'bg-warning' : 'bg-success');
            html += `
            <tr onclick="showDetail('${s.id}')">
                <td class="text-start ps-4 fw-bold">
                    <span class="status-dot status-online"></span>${s.id}
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="me-2 small" style="width:40px">${s.cpu.toFixed(0)}%</span>
                        <div class="progress flex-grow-1" style="height:6px">
                            <div class="progress-bar ${cpuClass}" style="width:${s.cpu}%"></div>
                        </div>
                    </div>
                </td>
                <td class="small text-muted">${formatBytes(s.mem_used)} / ${formatBytes(s.mem_total)}</td>
                <td class="small">
                    <span class="text-success">â†“${formatBytes(s.rx_speed)}/s</span> 
                    <span class="text-primary ms-2">â†‘${formatBytes(s.tx_speed)}/s</span>
                </td>
                <td class="small text-muted">${Math.round(s.disk_used/s.disk_total*100)}%</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function showDetail(id) {
        currentDetailId = id;
        document.getElementById('dashboard').classList.add('d-none');
        document.getElementById('detail').classList.remove('d-none');
        document.getElementById('detail-title').innerText = id;
        
        // åˆ‡æ¢æ—¶é”€æ¯æ—§å›¾è¡¨ï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™
        if(chartInstances.cpuRam) { chartInstances.cpuRam.destroy(); chartInstances.cpuRam = null; }
        if(chartInstances.net) { chartInstances.net.destroy(); chartInstances.net = null; }
        
        tick(); // ç«‹å³è§¦å‘ä¸€æ¬¡æ›´æ–°
    }

    function showDashboard() {
        currentDetailId = null;
        document.getElementById('detail').classList.add('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
    }

    function updateCharts(data) {
        const labels = data.map(() => ''); // ç©ºæ ‡ç­¾
        const cpuData = data.map(d => d.cpu);
        const ramData = data.map(d => (d.mem_used / d.mem_total * 100));
        const rxData = data.map(d => d.rx_speed / 1024); // KB/s
        const txData = data.map(d => d.tx_speed / 1024); // KB/s

        // ---- CPU & RAM å›¾è¡¨ ----
        const ctxCpu = document.getElementById('chartCpuRam').getContext('2d');
        if (!chartInstances.cpuRam) {
            // åˆå§‹åŒ–
            chartInstances.cpuRam = new Chart(ctxCpu, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'CPU',
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)', // åŠé€æ˜å¡«å……
                            borderWidth: 2,
                            data: cpuData,
                            fill: true // é¢ç§¯å›¾æ•ˆæœ
                        },
                        {
                            label: 'RAM',
                            borderColor: '#6610f2',
                            backgroundColor: 'rgba(102, 16, 242, 0.1)',
                            borderWidth: 2,
                            data: ramData,
                            fill: true
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: 100 } }
                }
            });
        } else {
            // å¢é‡æ›´æ–° (æ— åŠ¨ç”»)
            const chart = chartInstances.cpuRam;
            chart.data.labels = labels;
            chart.data.datasets[0].data = cpuData;
            chart.data.datasets[1].data = ramData;
            chart.update('none'); // 'none' æ¨¡å¼æ˜¯å…³é”®
        }

        // ---- Network å›¾è¡¨ ----
        const ctxNet = document.getElementById('chartNet').getContext('2d');
        if (!chartInstances.net) {
            chartInstances.net = new Chart(ctxNet, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'In (KB/s)',
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            data: rxData,
                            fill: true
                        },
                        {
                            label: 'Out (KB/s)',
                            borderColor: '#fd7e14',
                            backgroundColor: 'rgba(253, 126, 20, 0.1)',
                            borderWidth: 2,
                            data: txData,
                            fill: true
                        }
                    ]
                },
                options: commonOptions
            });
        } else {
            const chart = chartInstances.net;
            chart.data.labels = labels;
            chart.data.datasets[0].data = rxData;
            chart.data.datasets[1].data = txData;
            chart.update('none');
        }
    }

    // 1000ms åˆ·æ–°ç‡
    setInterval(tick, 1000);
    tick(); // å¯åŠ¨æ—¶ç«‹å³è¿è¡Œä¸€æ¬¡
</script>

</body>
</html>