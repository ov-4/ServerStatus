<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Status</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon">S</span> Server Status
            <span class="nav-subtitle">Server Status</span>
        </div>
        <div class="nav-controls">
            <a href="#" class="nav-link">Login</a>
            <button class="icon-btn"><i class="ri-search-line"></i></button>
            <button class="icon-btn"><i class="ri-translate-2"></i></button>
            <button class="icon-btn"><i class="ri-moon-line"></i></button>
            <div class="online-badge">
                <span class="status-dot online"></span> 0 Online
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="page-header">
            <h1>üëã Overview</h1>
            <div class="current-time">
                Where the time is <span id="current-time">00:00:00</span>
            </div>
        </div>

        <div id="summary-grid" class="summary-grid">
            <div class="summary-card">Loading...</div>
            <div class="summary-card">Loading...</div>
            <div class="summary-card">Loading...</div>
            <div class="summary-card network-card">Loading...</div>
        </div>

        <div class="filter-controls">
            <div class="filter-group">
                <button class="filter-btn active"><i class="ri-server-line"></i></button>
                <button class="filter-btn"><i class="ri-bar-chart-fill"></i></button>
                <button class="filter-btn"><i class="ri-apps-line"></i></button>
            </div>
            <button class="filter-btn sort-btn">Sort <i class="ri-arrow-up-down-line"></i></button>
        </div>

        <div id="dashboard-view">
            <div class="server-grid" id="server-grid">
                <div style="color: #a0aec0; text-align: center; grid-column: 1/-1; padding: 50px;">
                    Loading Wasm Module...
                </div>
            </div>
        </div>

        <div id="detail-view" class="detail-view" style="display: none;">
            <div class="detail-header-bar">
                <button class="btn-back" onclick="Module.cppBackToDashboard()">‚Üê Back</button>
                <h2 id="detail-title">Server Name</h2>
            </div>
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-box">
                        <canvas id="chart-cpu-mem"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-box">
                        <canvas id="chart-net"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div id="speedtest-stats-header" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #2d3748;">
                        </div>
                    
                    <div class="chart-box">
                        <canvas id="chart-speedtest"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Powered by <a href="https://github.com/ov-4/ServerStatus">Server Status</a></p>
    </footer>

    <script>
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('current-time').innerText = timeString;
        }
        setInterval(updateTime, 1000);
        updateTime();

        window.openDetail = function(id) {
            if (Module && Module.cppOpenDetail) {
                Module.cppOpenDetail(id);
            } else {
                console.error("Wasm Module not loaded or cppOpenDetail not found");
            }
        };

        let chartInstances = {};
        const CHART_COLORS = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'
        ];


        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }


        function renderSpeedtestHeader(canvasElement, stats, names) {
            let header = document.getElementById('speedtest-stats-header');
            if (!header) {
                header = document.createElement('div');
                header.id = 'speedtest-stats-header';
                header.style.cssText = `
                    display: flex; flex-wrap: wrap; gap: 20px; 
                    margin-bottom: 15px; padding-bottom: 15px; 
                    border-bottom: 1px solid #2d3748;
                `;
                canvasElement.parentNode.insertBefore(header, canvasElement);
            }

            header.innerHTML = names.map((name, i) => {
                const obj = stats[name];
                const avg = obj.count > 0 ? (obj.sum / obj.count).toFixed(2) : "0.00";
                const color = CHART_COLORS[i % CHART_COLORS.length];
                return `
                    <div style="flex: 1; min-width: 120px;">
                        <div style="font-size: 0.8rem; color: #a0aec0; margin-bottom: 4px; display: flex; align-items: center;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background-color: ${color}; margin-right: 6px; display: inline-block;"></span>
                            ${name}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 600; color: #e2e8f0; line-height: 1.2;">
                            ${avg}<span style="font-size: 0.9rem; font-weight: normal; color: #718096; margin-left: 2px;">ms</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #718096;">0% loss</div>
                    </div>
                `;
            }).join('');
        }


        window.updateChartsJS = function(jsonString) {
            let data;
            try {
                data = JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse history JSON", e);
                return;
            }


            const labels = data.map((_, i) => i); 
            const cpuData = data.map(d => d.cpu);
            const memData = data.map(d => (d.mem_used / d.mem_total) * 100);
            const netRx = data.map(d => d.rx_speed / 1024); // KB/s
            const netTx = data.map(d => d.tx_speed / 1024);

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                elements: { 
                    point: { radius: 0, hitRadius: 10, hoverRadius: 4 },
                    line: { borderWidth: 1.5, tension: 0.3 }
                },
                plugins: {
                    legend: { labels: { color: '#a0aec0', boxWidth: 10, font: { size: 11 } } },
                    tooltip: { 
                        backgroundColor: 'rgba(26, 32, 44, 0.9)',
                        titleColor: '#e2e8f0', bodyColor: '#cbd5e0', 
                        borderColor: '#4a5568', borderWidth: 1
                    }
                },
                scales: {
                    x: { display: false },
                    y: { 
                        grid: { color: '#2d3748', borderDash: [4, 4] }, 
                        ticks: { color: '#718096', maxTicksLimit: 5 }, 
                        beginAtZero: true 
                    }
                }
            };

            // ------------------------------------------------
            // 1. CPU & RAM Chart
            // ------------------------------------------------
            const ctx1 = document.getElementById('chart-cpu-mem').getContext('2d');
            if (!chartInstances.cpu) {
                chartInstances.cpu = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'CPU %', data: cpuData, borderColor: '#48bb78', backgroundColor: 'rgba(72, 187, 120, 0.1)', fill: true },
                            { label: 'RAM %', data: memData, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true }
                        ]
                    },
                    options: { 
                        ...commonOptions, 
                        plugins: { ...commonOptions.plugins, title: { display: true, text: 'Resource Usage', color: '#e2e8f0' } } 
                    }
                });
            } else {
                chartInstances.cpu.data.labels = labels;
                chartInstances.cpu.data.datasets[0].data = cpuData;
                chartInstances.cpu.data.datasets[1].data = memData;
                chartInstances.cpu.update('none');
            }

            // ------------------------------------------------
            // 2. Network Chart
            // ------------------------------------------------
            const ctx2 = document.getElementById('chart-net').getContext('2d');
            if (!chartInstances.net) {
                chartInstances.net = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'In (KB/s)', data: netRx, borderColor: '#ecc94b', backgroundColor: 'rgba(236, 201, 75, 0.1)', fill: true },
                            { label: 'Out (KB/s)', data: netTx, borderColor: '#f56565', backgroundColor: 'rgba(245, 101, 101, 0.1)', fill: true }
                        ]
                    },
                    options: { 
                        ...commonOptions, 
                        plugins: { ...commonOptions.plugins, title: { display: true, text: 'Network Traffic', color: '#e2e8f0' } } 
                    }
                });
            } else {
                chartInstances.net.data.labels = labels;
                chartInstances.net.data.datasets[0].data = netRx;
                chartInstances.net.data.datasets[1].data = netTx;
                chartInstances.net.update('none');
            }

            // ------------------------------------------------
            // 3. Speedtest Chart
            // ------------------------------------------------
            const speedtestCanvas = document.getElementById('chart-speedtest');
            if (speedtestCanvas) {
                const targetStats = {}; 
                const targetNames = [];

                data.forEach(point => {
                    if (point.speedtest && Array.isArray(point.speedtest)) {
                        point.speedtest.forEach(res => {
                            if (!targetStats[res.id]) {
                                targetStats[res.id] = { sum: 0, count: 0, data: new Array(data.length).fill(null) };
                                targetNames.push(res.id);
                            }
                        });
                    }
                });

                data.forEach((point, idx) => {
                    if (point.speedtest && Array.isArray(point.speedtest)) {
                        point.speedtest.forEach(res => {
                            if (targetStats[res.id]) {
                                const val = res.latency > 0 ? res.latency : null;
                                targetStats[res.id].data[idx] = val;
                                if (val !== null) {
                                    targetStats[res.id].sum += val;
                                    targetStats[res.id].count++;
                                }
                            }
                        });
                    }
                });

                renderSpeedtestHeader(speedtestCanvas, targetStats, targetNames);

                const datasets = targetNames.map((name, i) => {
                    const color = CHART_COLORS[i % CHART_COLORS.length];
                    targetStats[name].color = color; 
                    return {
                        label: name,
                        data: targetStats[name].data,
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 1.5,
                        pointRadius: 0,
                        hoverRadius: 4,
                        tension: 0.1,
                        spanGaps: true
                    };
                });

                const ctx3 = speedtestCanvas.getContext('2d');
                if (!chartInstances.speedtest) {
                    chartInstances.speedtest = new Chart(ctx3, {
                        type: 'line',
                        data: { labels: labels, datasets: datasets },
                        options: {
                            ...commonOptions,
                            plugins: {
                                ...commonOptions.plugins,
                                title: { display: false },
                                tooltip: {
                                    ...commonOptions.plugins.tooltip,
                                    callbacks: {
                                        label: function(context) {
                                            return ` ${context.dataset.label}: ${context.parsed.y.toFixed(2)} ms`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { ...commonOptions.scales.x, ticks: { ...commonOptions.scales.x.ticks, maxTicksLimit: 10 } },
                                y: { ...commonOptions.scales.y, title: { display: true, text: 'Latency (ms)', color: '#718096', font: {size: 10} } }
                            }
                        }
                    });
                } else {
                    chartInstances.speedtest.data.labels = labels;
                    chartInstances.speedtest.data.datasets = datasets;
                    chartInstances.speedtest.update('none');
                }
            }
        };
    </script>

    <script src="server_status.js"></script>
</body>
</html>